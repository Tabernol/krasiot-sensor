name: Deploy to OCI VM

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          docker build -t tabernol/krasiot-sensor:latest .
          docker push tabernol/krasiot-sensor:latest

      - name: SSH and deploy container on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            docker pull tabernol/krasiot-sensor:latest
            docker stop krasiot-sensor || true
            docker rm krasiot-sensor || true
            docker run -d --name krasiot-sensor \
              -v /path/on/vm/wallet:/opt/krasiot-sensor/wallet:ro \
              -e ADB_USERNAME='${{ secrets.ADB_USERNAME }}' \
              -e ADB_PASSWORD='${{ secrets.ADB_PASSWORD }}' \
              -e ADB_CONN_STRING='${{ secrets.ADB_CONN_STRING }}' \
              -e ADB_WALLET_LOCATION='/opt/krasiot-sensor/wallet' \
              -e ADB_LIB_DIR='/opt/oracle/instantclient_19_10' \
              -e TNS_ADMIN='/opt/krasiot-sensor/wallet' \
              -e MQTT_HOST='${{ secrets.MQTT_HOST }}' \
              -e MQTT_PORT='${{ secrets.MQTT_PORT }}' \
              -e MQTT_USERNAME='${{ secrets.MQTT_USERNAME }}' \
              -e MQTT_PASSWORD='${{ secrets.MQTT_PASSWORD }}' \
              -e MQTT_CLIENT_ID='${{ secrets.MQTT_CLIENT_ID }}' \
              -e MQTT_TOPIC='${{ secrets.MQTT_TOPIC }}' \
              tabernol/krasiot-sensor:latest





#name: Deploy to OCI VM
#
#on:
#  push:
#    branches: [main]
#
#jobs:
#  deploy:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Set up Go
#        uses: actions/setup-go@v5
#        with:
#          go-version: '1.22.12'
#
#      - name: Build Linux ARM64 binary
#        run: |
#          export GOOS=linux
#          export GOARCH=arm64
#          go build -o app
#          echo "‚úÖ Binary built for Linux ARM64."
#
#      - name: Copy binary to VM
#        uses: appleboy/scp-action@v0.1.7
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          source: "app"
#          target: "~/krasiot-sensor"
#
#      - name: Restart app on VM
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_PRIVATE_KEY }}
#          script: |
#            pkill app || true
#            cd ~/krasiot-sensor
#            chmod +x app
#            export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'
#            export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'
#            export MQTT_HOST='${{ vars.MQTT_HOST }}'
#            export MQTT_PORT='${{ vars.MQTT_PORT }}'
#            export MQTT_USERNAME='${{ secrets.MQTT_USERNAME }}'
#            export MQTT_PASSWORD='${{ secrets.MQTT_PASSWORD }}'
#            export MQTT_CLIENT_ID='${{ vars.MQTT_CLIENT_ID }}'
#            export MQTT_TOPIC='${{ vars.MQTT_TOPIC }}'
#            echo "MQTT_PORT=$MQTT_PORT"         # üëà Add this debug output
#            nohup ./app > app.log 2>&1 &
#            echo "‚úÖ App started. Last 10 log lines:"
#            sleep 3
#            tail -n 10 app.log || echo "‚ö†Ô∏è Log file not found."
